<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bar & Panini - Cassa Touch</title>
<style>
/* -------------------- Layout app -------------------- */
body {
  margin:0;
  font-family: 'Arial', sans-serif;
  background:#f0f2f5;
  display:flex;
  justify-content:center;
  padding:20px;
  -webkit-font-smoothing:antialiased;
}
.app {
  display:flex;
  flex-wrap:wrap;
  gap:20px;
  max-width:1400px;
  width:100%;
  align-items:flex-start;
}
.menu, .cart {
  background:#fff;
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
}
.menu { flex:1 1 650px; }
.cart { flex:1 1 520px; display:flex; flex-direction:column; position:relative; }
h2 { margin-top:0; color:#ff6b35; font-weight:700; font-size:1.6em; }
.section-title { margin-top:12px; font-size:1.15em; font-weight:700; color:#333; }
.product {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#fafafa;
  padding:12px;
  margin-bottom:10px;
  border-radius:12px;
  border:1px solid #eee;
}
.product .label { display:flex; gap:8px; align-items:center; }
.btn {
  background:#ff6b35;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  color:#fff;
  cursor:pointer;
  transition:transform .08s;
  font-size:0.95em;
}
.btn:active { transform: translateY(1px); }
.btn.secondary { background:#555; }
.btn.satispay { background:#e60019; }
.btn.green { background:#28a745; }
.item-row {
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
  border-bottom:1px dashed #eee;
  padding-bottom:6px;
  font-size:0.95em;
}
.receipt, .preview {
  background:#fafafa;
  padding:12px;
  border-radius:10px;
  margin-top:12px;
  font-family: monospace;
  white-space: pre-wrap;
  border:1px solid #e6e6e6;
  word-wrap: break-word;
  font-size:13px;
  line-height:1.15;
}
/* chips */
.chip {
  display:inline-block;
  padding:6px 10px;
  margin:4px;
  border-radius:18px;
  border:1px solid #ccc;
  cursor:pointer;
  user-select:none;
  font-size:0.9em;
}
.chip.selected { background:#ff6b35; color:#fff; border-color:#ff6b35; }

/* keypad */
#numPad { display:none; margin-top:10px; }
#numPad .row { display:flex; gap:8px; justify-content:center; margin-bottom:6px; }
#numPad button { width:60px; height:50px; border-radius:8px; border:none; background:#ff6b35; color:#fff; font-size:1.05em; cursor:pointer; }
#numPad .btn-clear { background:#777; }

/* reset column */
.reset-section { display:flex; flex-direction:column; gap:8px; margin-top:12px; position:sticky; bottom:10px; }
.reset-section .btn { width:100%; }

/* responsive */
@media (max-width:1024px){
  .app { flex-direction:column; align-items:center; }
  .menu, .cart { flex:1 1 100%; max-width:95%; }
}

/* -------------------- Print styles (TERMICA 58mm) -------------------- */
@page {
  size: 58mm auto;
  margin: 0;
}
@media print {
  body * { visibility: hidden !important; }
  #printArea, #printArea * { visibility: visible !important; }
  #printArea {
    position: absolute;
    left: 0;
    top: 0;
    width: 58mm;
    padding: 4px;
    margin: 0;
    box-shadow: none;
  }
  pre { margin:0; }
  .no-print { display:none !important; }
}
#printArea .ticket {
  width: 58mm;
  font-family: monospace;
  font-size:12px;
  line-height:1.1;
  white-space: pre-wrap;
  color:#000;
}
</style>

<!-- ==== QZ Tray Script ==== -->
<script src="https://cdn.jsdelivr.net/npm/qz-tray@2.1.0/qz-tray.js"></script>

</head>
<body>
<div class="app">
  <!-- MENU e CARRELLO come prima -->
  <!-- Copia tutto il tuo HTML precedente per menu e carrello qui, senza modifiche -->
</div>

<!-- AREA STAMPABILE (solo print) -->
<div id="printArea" class="no-print" aria-hidden="true" style="position:fixed; right:9999px; top:0;">
  <div class="ticket" id="ticketContent"></div>
</div>

<script>
// ===================== Dati =====================
let cart = [];
let totalCash = 0;
let totalSatispay = 0;
function formatMoney(v){ return Number(v).toFixed(2).replace('.',',') + ' â‚¬'; }

// ===================== Carrello =====================
function renderCart(){
  const cartItems = document.getElementById('cartItems');
  cartItems.innerHTML = '';
  let grouped = {};
  cart.forEach(item=>{
    const key = item.name + (item.meta ? '|' + item.meta.join(',') : '');
    if(grouped[key]) grouped[key].qty += item.qty;
    else grouped[key] = Object.assign({}, item);
  });
  Object.values(grouped).forEach(item=>{
    const div = document.createElement('div');
    div.className = 'item-row';
    const metaText = item.meta ? ' (' + item.meta.join(', ') + ')' : '';
    div.innerHTML = `${item.qty} x ${item.name}${metaText} <span>${formatMoney(item.price*item.qty)}</span>
      <button class="btn" onclick="removeItemEscaped('${escapeForJS(item.name)}','${escapeForJS(item.meta?item.meta.join(','):'')}')" style="padding:4px 8px; margin-left:8px;">âœ–</button>`;
    cartItems.appendChild(div);
  });
  const total = cart.reduce((a,b)=>a + b.price*b.qty, 0);
  document.getElementById('totalAmount').innerText = formatMoney(total);
  updateReceipt();
}

function escapeForJS(s){ if(!s) return ''; return s.replace(/'/g,"\\'").replace(/"/g,'\\"'); }
function addToCart(item){ cart.push(item); renderCart(); }
function removeItemEscaped(name, meta){
  name = name.replace(/\\'/g,"'").replace(/\\"/g,'"'); meta = meta.replace(/\\'/g,"'").replace(/\\"/g,'"');
  for(let i=0;i<cart.length;i++){ const itm=cart[i]; const keyMeta=itm.meta?itm.meta.join(','):''; if(itm.name===name&&keyMeta===meta){cart.splice(i,1); break;} }
  renderCart();
}
function clearCart(){ cart=[]; renderCart(); }

// ===================== Scontrino =====================
function buildTicketText(metodo){
  const lines=[];
  lines.push('BAR & PANINI');
  lines.push('ðŸ“ Cuneo, Piccapietra');
  lines.push('-----------------------------');
  const grouped={};
  cart.forEach(item=>{ const key=item.name+(item.meta? '|'+item.meta.join(','):''); if(grouped[key]) grouped[key].qty+=item.qty; else grouped[key]=Object.assign({},item); });
  Object.values(grouped).forEach(item=>{
    const qty=item.qty;
    const name=item.name;
    lines.push(qty+' x '+name);
    if(item.meta) lines.push('  '+item.meta.join(', '));
    lines.push('  '+formatMoney(item.price*item.qty));
  });
  const total=cart.reduce((a,b)=>a+b.price*b.qty,0);
  lines.push('-----------------------------');
  lines.push('Totale: '+formatMoney(total));
  lines.push('Pagamento: '+(metodo||'').toUpperCase());
  lines.push('');
  lines.push('Grazie e Buon Torneo!');
  lines.push('\x1B\x40'); // ESC @ = reset stampante
  lines.push('\x1D\x56\x41'); // Taglio carta
  lines.push('\n\n\n'); // righe extra
  return lines.join('\n');
}

function updateReceipt(){
  const preview=document.getElementById('receiptPreview');
  const ticketContent=document.getElementById('ticketContent');
  const text=buildTicketText('');
  preview.innerText=text;
  ticketContent.innerText=text;
}

// ===================== QZ Tray Print =====================
function printReceipt(metodo){
  if(cart.length===0){ alert('Il carrello Ã¨ vuoto!'); return; }
  const text = buildTicketText(metodo);

  // Connessione QZ Tray
  qz.websocket.connect().then(()=>{
    return qz.printers.find().then(printer => {
      console.log('Stampante trovata: ', printer);
      const config = qz.configs.create(printer);
      return qz.print(config, [{ type: 'raw', format: 'plain', data: text }]);
    });
  }).catch(err=>{
    console.error(err);
    alert('Errore stampa: '+err);
  }).finally(()=>{
    qz.websocket.disconnect();
  });

  // Aggiorna totali
  const total=cart.reduce((a,b)=>a+b.price*b.qty,0);
  if(metodo==='contanti') totalCash+=total; else if(metodo==='satispay') totalSatispay+=total;

  // Reset carrello
  cart=[]; renderCart();
  document.getElementById('cashGiven').value='';
  document.getElementById('changeAmount').innerText=formatMoney(0);
}

// ===================== Eventi UI =====================
// Copia tutti gli event listener dal tuo file originale, solo modifica quelli dei pulsanti di pagamento:
document.getElementById('printBtn').addEventListener('click', ()=>{ printReceipt('contanti'); });
document.getElementById('paySatispay').addEventListener('click', ()=>{ printReceipt('satispay'); });

// Tutti gli altri event listener (panini, numPad, reset, etc.) rimangono identici come nel tuo file originale

renderCart();
</script>
</body>
</html>




